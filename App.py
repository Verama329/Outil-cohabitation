# app.py# Streamlit web app — Le Radar de Maturité en Cohabitation# Run: streamlit run app.py## Dependencies:#   pip install streamlit plotly reportlabfrom __future__ import annotationsfrom dataclasses import dataclassfrom io import BytesIOfrom typing import Dict, List, Tupleimport plotly.graph_objects as goimport streamlit as stfrom reportlab.lib.pagesizes import A4from reportlab.lib.units import cmfrom reportlab.pdfgen import canvas# -----------------------------# Données (questionnaire + profils)# -----------------------------@dataclass(frozen=True)class Option:    code: str  # "A".."D"    points: int  # 1..4    niveau: str  # "Réactif".."Systémique"    texte: str   # texte descriptif complet@dataclass(frozen=True)class Question:    id: str      # "Q1".."Q12"    axe: str     # "A", "B", "C"    titre_axe: str    question: str    options: List[Option]@dataclass(frozen=True)class Profil:    min_score: int    max_score: int    nom: str    realite: str    action: str    chapitres: strAXE_META = {    "A": ("Gouvernance & Protocoles", "« Est-ce que c'est écrit, clair et appliqué ? »"),    "B": ("Opérations & Terrain", "« Comment on réagit concrètement aux situations de crise ? »"),    "C": ("Alliances & Partenariats", "« Travaille-t-on seul ou en réseau ? »"),}QUESTIONS: List[Question] = [    Question(        id="Q1",        axe="A",        titre_axe=AXE_META["A"][0],        question="Votre organisme dispose-t-il d'un protocole écrit de gestion des comportements problématiques (violence, menaces, consommation ostentatoire) ?",        options=[            Option("A", 1, "Réactif", "Non, on gère au cas par cas selon l'intervenant de garde. Chacun a sa méthode."),            Option("B", 2, "Formel", "Oui, on a un règlement interne affiché, mais il est rarement appliqué de façon cohérente (dépend de qui est de service)."),            Option("C", 3, "Collaboratif", "Oui, on a un protocole écrit et l'équipe le connaît. On fait des ajustements réguliers en réunion clinique."),            Option("D", 4, "Systémique", "Oui, on a un protocole d'intervention graduée (niveaux vert-jaune-rouge), documenté, appliqué de façon cohérente, et révisé annuellement avec l'équipe."),        ],    ),    Question(        id="Q2",        axe="A",        titre_axe=AXE_META["A"][0],        question="Avez-vous formalisé vos engagements avec le voisinage (pacte, entente, rencontres structurées) ?",        options=[            Option("A", 1, "Réactif", "Non, on réagit seulement quand il y a une plainte. On n'a pas de contact proactif avec les voisins."),            Option("B", 2, "Formel", "On a eu une rencontre d'information lors de l'ouverture, mais rien de structuré depuis. Les citoyens appellent directement la Ville quand ils sont insatisfaits."),            Option("C", 3, "Collaboratif", "On organise des rencontres périodiques (2-4 fois par année) avec un comité de citoyens. Le dialogue existe, mais ce n'est pas formalisé par écrit."),            Option("D", 4, "Systémique", "On a signé un Pacte de bon voisinage écrit avec des engagements clairs de part et d'autre, des rencontres trimestrielles, et un mécanisme de résolution de conflits défini."),        ],    ),    Question(        id="Q3",        axe="A",        titre_axe=AXE_META["A"][0],        question="Les rôles et responsabilités entre votre organisme, la Ville, le CIUSSS et les partenaires sont-ils clairs et documentés ?",        options=[            Option("A", 1, "Réactif", "Non, on ne sait pas toujours qui doit faire quoi. On se renvoie souvent la balle entre organismes."),            Option("B", 2, "Formel", "On a des ententes de service signées, mais dans les faits, les zones grises créent de la confusion sur le terrain."),            Option("C", 3, "Collaboratif", "Les rôles sont relativement clairs. On se parle régulièrement pour ajuster. Ça fonctionne bien grâce aux relations interpersonnelles."),            Option("D", 4, "Systémique", "On a un cadre de gouvernance écrit (qui fait quoi, qui décide quoi, qui finance quoi), partagé avec tous les partenaires, et une instance de coordination active."),        ],    ),    Question(        id="Q4",        axe="A",        titre_axe=AXE_META["A"][0],        question="Mesurez-vous l'impact de vos interventions de cohabitation (données, indicateurs, rapports) ?",        options=[            Option("A", 1, "Réactif", "Non, on n'a pas le temps de compiler des données. On se fie à notre « feeling » terrain."),            Option("B", 2, "Formel", "On collecte quelques données (nombre de refus, incidents), mais on ne les analyse pas vraiment ni ne les partage."),            Option("C", 3, "Collaboratif", "On suit des indicateurs de base (taux d'occupation, incidents, plaintes du voisinage) et on les présente en réunion d'équipe ou au CA."),            Option("D", 4, "Systémique", "On a un tableau de bord avec des indicateurs clairs (sécurité, propreté, satisfaction voisinage, taux de réintégration), analysés mensuellement, et partagés avec nos bailleurs de fonds."),        ],    ),    Question(        id="Q5",        axe="B",        titre_axe=AXE_META["B"][0],        question="Comment gérez-vous les crises médiatiques (vidéo virale, article négatif, pression des citoyens sur les réseaux sociaux) ?",        options=[            Option("A", 1, "Réactif", "On subit. On ne sait jamais quoi dire. Souvent, on ne dit rien et on espère que ça passe."),            Option("B", 2, "Formel", "On réagit au cas par cas, souvent avec retard. On publie un communiqué générique qui satisfait rarement les gens."),            Option("C", 3, "Collaboratif", "On a identifié un porte-parole interne. On prépare des messages-clés adaptés à la situation et on répond rapidement (dans les 24-48h)."),            Option("D", 4, "Systémique", "On a un plan de communication de crise documenté, avec des messages pré-approuvés, un protocole de gestion des médias sociaux, et une stratégie proactive (on communique AVANT que les problèmes n'explosent)."),        ],    ),    Question(        id="Q6",        axe="B",        titre_axe=AXE_META["B"][0],        question="Vos intervenants sont-ils formés spécifiquement à la gestion de la cohabitation sociale (pas juste à l'intervention clinique) ?",        options=[            Option("A", 1, "Réactif", "Non, on embauche des gens avec de l'expérience en intervention, mais on n'offre pas de formation spécifique sur la cohabitation avec le voisinage."),            Option("B", 2, "Formel", "On a fait une formation ponctuelle lors de l'ouverture, mais rien de continu. Les nouvelles recrues apprennent « sur le tas »."),            Option("C", 3, "Collaboratif", "On organise des formations internes régulières (désescalade, médiation, gestion des plaintes) et on fait des débriefs d'incidents en équipe."),            Option("D", 4, "Systémique", "Tous les intervenants reçoivent une formation structurée en cohabitation sociale (CPTED, réduction des méfaits, communication non-violente), avec des mises à jour annuelles et des supervisions cliniques régulières."),        ],    ),    Question(        id="Q7",        axe="B",        titre_axe=AXE_META["B"][0],        question="Quelle est votre capacité à intervenir HORS de votre bâtiment (parvis, ruelle adjacente, parc à proximité) ?",        options=[            Option("A", 1, "Réactif", "On ne sort pas. On gère seulement ce qui se passe à l'intérieur. L'extérieur, c'est « pas notre problème »."),            Option("B", 2, "Formel", "On sort parfois si un citoyen se plaint, mais on n'a pas de protocole clair ni de ressources dédiées."),            Option("C", 3, "Collaboratif", "On a des intervenants qui font des rondes régulières sur le parvis et aux abords immédiats (rayon de 10-20m). On nettoie quotidiennement."),            Option("D", 4, "Systémique", "On gère activement une « zone tampon » de 50-100m autour de notre établissement : nettoyage structuré, présence visible, médiation proactive avec les usagers et le voisinage."),        ],    ),    Question(        id="Q8",        axe="B",        titre_axe=AXE_META["B"][0],        question="Avez-vous un processus clair pour gérer les exclusions (barring) et les retours après exclusion ?",        options=[            Option("A", 1, "Réactif", "Non, les exclusions sont décidées de façon arbitraire selon l'humeur de l'intervenant. Pas de procédure de retour."),            Option("B", 2, "Formel", "On exclut quand c'est grave, mais les durées varient beaucoup. Parfois les gens reviennent sans rencontre, parfois non."),            Option("C", 3, "Collaboratif", "On a une grille d'exclusion selon la gravité (violence = X jours). Les retours nécessitent généralement une rencontre avec un intervenant."),            Option("D", 4, "Systémique", "On a un protocole d'intervention graduée (vert-jaune-rouge) avec des durées d'exclusion proportionnées, des rencontres de retour obligatoires, et un suivi documenté dans le dossier clinique."),        ],    ),    Question(        id="Q9",        axe="C",        titre_axe=AXE_META["C"][0],        question="Quelle est la qualité de votre relation avec les services municipaux (police, 311, propreté, urbanisme) ?",        options=[            Option("A", 1, "Réactif", "On n'a presque pas de contact. Quand on se parle, c'est souvent tendu (ils nous voient comme « le problème »)."),            Option("B", 2, "Formel", "On se connaît de nom, on s'échange des courriels administratifs, mais il n'y a pas vraiment de collaboration terrain."),            Option("C", 3, "Collaboratif", "On a des contacts réguliers et constructifs. On peut appeler le poste de quartier ou le responsable municipal quand il y a un enjeu."),            Option("D", 4, "Systémique", "On siège à une table de concertation locale avec la Ville, la police communautaire, et d'autres partenaires. On co-construit des solutions et on partage des données."),        ],    ),    Question(        id="Q10",        axe="C",        titre_axe=AXE_META["C"][0],        question="Collaborez-vous avec d'autres organismes du secteur (refuges, haltes, centres de jour, santé) pour gérer collectivement la cohabitation ?",        options=[            Option("A", 1, "Réactif", "Non, chacun gère son coin. On se voit comme des compétiteurs (pour le financement, pour les usagers)."),            Option("B", 2, "Formel", "On se parle occasionnellement, mais chacun reste dans son silo. On ne partage pas vraiment d'information ni de stratégie."),            Option("C", 3, "Collaboratif", "On participe à une table de concertation locale. On échange sur les cas complexes et on se réfère mutuellement des usagers."),            Option("D", 4, "Systémique", "On fait partie d'un réseau structuré avec des protocoles de collaboration clairs (partage d'info, gestion des exclusions croisées, stratégies communes de cohabitation, financement partagé pour médiation sociale)."),        ],    ),    Question(        id="Q11",        axe="C",        titre_axe=AXE_META["C"][0],        question="Impliquez-vous les citoyens/voisins de manière constructive (au-delà de « gérer les plaintes ») ?",        options=[            Option("A", 1, "Réactif", "Non, on évite les citoyens. Quand ils appellent, on subit leurs reproches. On n'a pas de stratégie d'engagement."),            Option("B", 2, "Formel", "On répond poliment aux plaintes, mais on ne cherche pas à créer une relation proactive avec le voisinage."),            Option("C", 3, "Collaboratif", "On organise des rencontres de voisinage 2-3 fois par année. Les citoyens peuvent nous poser des questions et on explique notre mission."),            Option("D", 4, "Systémique", "On a co-créé un Comité de bon voisinage avec des résidents volontaires. Ils participent à des activités (nettoyage collectif, 5 à 7, portes ouvertes) et deviennent des « ambassadeurs » de la cohabitation."),        ],    ),    Question(        id="Q12",        axe="C",        titre_axe=AXE_META["C"][0],        question="Avez-vous accès à des ressources de médiation sociale ou de travail de proximité dédiées à la cohabitation (pas juste à l'intervention clinique) ?",        options=[            Option("A", 1, "Réactif", "Non, nos intervenants font tout : clinique + gestion des plaintes + médiation. Ils sont débordés."),            Option("B", 2, "Formel", "On aimerait avoir de la médiation, mais on n'a pas le budget. On se débrouille avec nos ressources internes."),            Option("C", 3, "Collaboratif", "On a parfois accès à un médiateur externe (via la Ville ou un partenaire), mais ce n'est pas systématique ni financé de façon stable."),            Option("D", 4, "Systémique", "On a un poste dédié (agent de milieu, médiateur social, intervenant de proximité) financé spécifiquement pour gérer la zone tampon et les relations avec le voisinage. C'est distinct de l'intervention clinique."),        ],    ),]PROFILS: List[Profil] = [    Profil(        12, 24, "Le Pompier Solitaire",        "Vous êtes en mode survie. Votre équipe gère au jour le jour, sans protocoles formalisés, avec peu ou pas de collaboration structurée avec le voisinage ou les partenaires externes. Les crises éclatent, vous réagissez, et vous recommencez le lendemain.\n\n"        "Forces : proximité terrain, résilience, connaissance fine des usagers.\n"        "Risques : épuisement, incohérence, vulnérabilité médiatique, isolement institutionnel.",        "Commencez par UNE chose : créer votre premier protocole d'intervention écrit (comportements problématiques). "        "Objectif : réduire l'arbitraire, améliorer la cohérence, protéger l'organisme et faciliter la réponse aux plaintes.",        "Priorité 1 : Chapitre 3.\nPriorité 2 : Chapitre 1 et Chapitre 6."    ),    Profil(        25, 33, "Le Gestionnaire Structuré",        "Vous avez des bases solides (protocoles, règles, organisation), mais l'application varie et les partenariats demeurent informels. "        "Vous gérez les plaintes plus que vous ne construisez une relation de confiance.",        "Formalisez vos relations avec le voisinage : créez un Pacte de bon voisinage (engagements, mécanisme de résolution, rencontres).",        "Priorité 1 : Chapitre 4 et Chapitre 5.\nPriorité 2 : Chapitre 7 et Chapitre 6."    ),    Profil(        34, 42, "Le Partenaire Stratégique",        "Vous avez des protocoles solides, des partenariats actifs et une relation constructive avec le voisinage. "        "Vous êtes reconnu comme un acteur de solutions, mais souhaitez optimiser (proactivité, mesure d’impact, innovation).",        "Structurez un tableau de bord d'impact et utilisez-le comme levier (financement, influence, réputation, apprentissage).",        "Priorité 1 : Chapitre 8 et Chapitre 7.\nPriorité 2 : Chapitre 6 et Chapitre 2."    ),    Profil(        43, 48, "L’Innovateur Systémique",        "Vous êtes une référence : protocoles, partenariats stratégiques, mesure d’impact, communication proactive, implication citoyenne structurée. "        "Vous co-construisez la cohabitation à l’échelle du système.",        "Documentez vos pratiques et partagez-les (essaimage, mentorat, outils, études de cas). Votre levier : multiplier l’impact.",        "Priorité 1 : Chapitre 8 et Conclusion.\nPriorité 2 : lecture transversale orientée transfert de pratiques."    ),]# -----------------------------# Fonctions métier# -----------------------------def option_label(opt: Option) -> str:    # Ultra explicite : on affiche A/B/C/D + points + niveau + description    return f"{opt.code}. ({opt.points} pt) — {opt.niveau}\n? {opt.texte}"def compute_scores(answers: Dict[str, str]) -> Tuple[int, Dict[str, int]]:    # answers: {"Q1": "A", ...}    per_axis = {"A": 0, "B": 0, "C": 0}    total = 0    for q in QUESTIONS:        code = answers.get(q.id, "")        if not code:            continue        opt = next(o for o in q.options if o.code == code)        total += opt.points        per_axis[q.axe] += opt.points    return total, per_axisdef resolve_profile(total_score: int) -> Profil | None:    if total_score <= 0:        return None    for p in PROFILS:        if p.min_score <= total_score <= p.max_score:            return p    # sécurité (si jamais score partiel en dessous de 12)    return Nonedef make_radar(per_axis: Dict[str, int]) -> go.Figure:    labels = [        "Gouvernance & Protocoles",        "Opérations & Terrain",        "Alliances & Partenariats",    ]    values = [per_axis["A"], per_axis["B"], per_axis["C"]]    # fermer la boucle    labels_closed = labels + [labels[0]]    values_closed = values + [values[0]]    fig = go.Figure()    fig.add_trace(go.Scatterpolar(        r=values_closed,        theta=labels_closed,        fill="toself",        name="Score par axe",        hovertemplate="%{theta}<br>Score: %{r}/16<extra></extra>",    ))    fig.update_layout(        polar=dict(            radialaxis=dict(visible=True, range=[0, 16], tick0=0, dtick=4)        ),        showlegend=False,        margin=dict(l=30, r=30, t=30, b=30),        height=420,    )    return figdef pdf_report_bytes(    answers: Dict[str, str],    total: int,    per_axis: Dict[str, int],    profile: Profil | None,) -> bytes:    buf = BytesIO()    c = canvas.Canvas(buf, pagesize=A4)    width, height = A4    # Header    c.setFont("Helvetica-Bold", 16)    c.drawString(2*cm, height - 2.2*cm, "Le Radar de Maturité en Cohabitation — Rapport")    c.setFont("Helvetica", 10)    c.drawString(2*cm, height - 2.9*cm, "Auto-diagnostic stratégique (résumé)")    # Scores    y = height - 4.1*cm    c.setFont("Helvetica-Bold", 12)    c.drawString(2*cm, y, f"Score total : {total} / 48")    y -= 0.8*cm    c.setFont("Helvetica", 11)    c.drawString(2*cm, y, f"Axe A (Gouvernance & Protocoles) : {per_axis['A']} / 16")    y -= 0.6*cm    c.drawString(2*cm, y, f"Axe B (Opérations & Terrain) : {per_axis['B']} / 16")    y -= 0.6*cm    c.drawString(2*cm, y, f"Axe C (Alliances & Partenariats) : {per_axis['C']} / 16")    # Profil    y -= 1.2*cm    c.setFont("Helvetica-Bold", 12)    if profile:        c.drawString(2*cm, y, f"Profil : {profile.nom} ({profile.min_score}–{profile.max_score})")    else:        c.drawString(2*cm, y, "Profil : (score insuffisant ou questionnaire incomplet)")    def draw_paragraph(title: str, text: str, y: float) -> float:        c.setFont("Helvetica-Bold", 11)        c.drawString(2*cm, y, title)        y -= 0.55*cm        c.setFont("Helvetica", 10)        # wrap simple        max_width = width - 4*cm        words = text.replace("\n", " ").split()        line = ""        for w in words:            candidate = (line + " " + w).strip()            if c.stringWidth(candidate, "Helvetica", 10) <= max_width:                line = candidate            else:                c.drawString(2*cm, y, line)                y -= 0.45*cm                line = w                if y < 3*cm:                    c.showPage()                    y = height - 2.5*cm                    c.setFont("Helvetica", 10)        if line:            c.drawString(2*cm, y, line)            y -= 0.65*cm        return y    if profile:        y -= 0.8*cm        y = draw_paragraph("Votre réalité (synthèse)", profile.realite, y)        y = draw_paragraph("Action prioritaire", profile.action, y)        y = draw_paragraph("Chapitres recommandés", profile.chapitres, y)    # Réponses    y -= 0.2*cm    c.setFont("Helvetica-Bold", 11)    c.drawString(2*cm, y, "Vos réponses (A–D)")    y -= 0.6*cm    c.setFont("Helvetica", 10)    for q in QUESTIONS:        code = answers.get(q.id, "—")        line = f"{q.id} : {code}"        c.drawString(2*cm, y, line)        y -= 0.42*cm        if y < 2.2*cm:            c.showPage()            y = height - 2.5*cm            c.setFont("Helvetica", 10)    c.showPage()    c.save()    return buf.getvalue()# -----------------------------# UI Streamlit# -----------------------------st.set_page_config(page_title="Radar de Maturité — Cohabitation", layout="wide")st.title("Le Radar de Maturité en Cohabitation")st.caption("Outil d'auto-diagnostic stratégique — 5 minutes pour savoir par où commencer")with st.expander("Mode d'emploi (à lire une fois)", expanded=False):    st.markdown(        """**Cet outil n'est pas un examen. C'est une boussole.**  Choisissez, pour chaque question, la réponse qui reflète le mieux votre réalité actuelle (pas l'idéal).  Résultat : score total /48, score par axe /16, profil + action prioritaire + lectures recommandées.        """.strip()    )# Init stateif "answers" not in st.session_state:    st.session_state["answers"] = {q.id: "A" for q in QUESTIONS}  # défaut (modifiable)answers: Dict[str, str] = st.session_state["answers"]# Sidebar (12 questions radio ultra explicites)st.sidebar.header("Questionnaire (12 questions)")st.sidebar.caption("Choisissez A, B, C ou D pour chaque question (texte complet inclus).")current_axis = Nonefor q in QUESTIONS:    if q.axe != current_axis:        current_axis = q.axe        st.sidebar.markdown("---")        st.sidebar.subheader(f"Axe {q.axe} — {AXE_META[q.axe][0]}")        st.sidebar.caption(AXE_META[q.axe][1])    labels = [option_label(o) for o in q.options]    default_index = ["A", "B", "C", "D"].index(answers.get(q.id, "A"))    selected_label = st.sidebar.radio(        label=f"{q.id}. {q.question}",        options=labels,        index=default_index,        key=f"radio_{q.id}",    )    # Convert label back to code    selected_code = selected_label.split(".")[0].strip()  # "A"    answers[q.id] = selected_codest.session_state["answers"] = answers# Computetotal, per_axis = compute_scores(answers)profile = resolve_profile(total)# Main layoutcol_left, col_right = st.columns([1.05, 1.25], gap="large")with col_left:    st.subheader("Scores (mise à jour en temps réel)")    k1, k2, k3, k4 = st.columns(4)    k1.metric("Total", f"{total} / 48")    k2.metric("Axe A", f"{per_axis['A']} / 16")    k3.metric("Axe B", f"{per_axis['B']} / 16")    k4.metric("Axe C", f"{per_axis['C']} / 16")    weakest_axis = min(per_axis.items(), key=lambda kv: kv[1])[0]    st.info(f"**Axe à prioriser (score le plus faible)** : Axe {weakest_axis} — {AXE_META[weakest_axis][0]}")    st.subheader("Graphique Radar")    st.plotly_chart(make_radar(per_axis), use_container_width=True)with col_right:    st.subheader("Résultats")    if profile is None:        st.warning(            "Le profil s’affiche pleinement quand le score total est dans les plages 12–48. "            "Si vous souhaitez autoriser l’affichage dès un score partiel, on peut ajuster la règle."        )    else:        st.success(f"**Votre profil : {profile.nom}** (score {profile.min_score}–{profile.max_score})")        st.markdown("### ?? Votre réalité (synthèse)")        st.write(profile.realite)        st.markdown("### ?? Action prioritaire (Low Hanging Fruit)")        st.write(profile.action)        st.markdown("### ?? Chapitres recommandés")        st.write(profile.chapitres)    st.markdown("---")    st.subheader("Télécharger mon rapport (PDF)")    st.caption("Génère un PDF récapitulatif : scores, profil, action, lectures, et vos réponses.")    pdf_bytes = pdf_report_bytes(answers, total, per_axis, profile)    st.download_button(        label="?? Télécharger mon rapport PDF",        data=pdf_bytes,        file_name="Rapport_Radar_Cohabitation.pdf",        mime="application/pdf",        use_container_width=True,    )st.markdown("---")st.caption("Note : Les points sont calculés selon A=1, B=2, C=3, D=4. Score max : 48. Axes : 4 questions par axe, max 16.")